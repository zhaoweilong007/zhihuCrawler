# 计算机是如何计算 log 函数的？
- 点赞数：5171
- 更新时间：2022年11月28日08时25分51秒
- 回答url：https://www.zhihu.com/question/333371020/answer/1686069171
<body>
 <p data-pid="QwMLW0Vd">不要听什么歪门邪道，我们看标准方案，这套方案是 1993 年由 Sun Microsystems 正式写入 C 标准库的方案，函数为 <code>double ieee754log(double x)</code>（ieee754: IEEE二进制浮点数算术标准）。但这套方法为了性能的苛刻而写得过于复杂，我提核心的捡。</p>
 <p data-pid="nN0TNDXB">总体思路：所有的对数函数计算核心都是利用多项式展开（泰勒级数）然后多项式求和计算结果。为了性能或者精度的要求可能会对展开后的求和式子做进一步优化，最终会封装一个 <img src="https://www.zhihu.com/equation?tex=%5Cln" alt="\ln" eeimg="1"> 函数出来。其余的对数函数都是使用换底公式来套 <img src="https://www.zhihu.com/equation?tex=%5Cln" alt="\ln" eeimg="1"> 函数做的最底层实现，随着大量图形运算的需求提升， <img src="https://www.zhihu.com/equation?tex=%5Cln" alt="\ln" eeimg="1"> 函数实现得好不好直接决定你电脑快不快。</p>
 <p data-pid="KaPuJU19">我们具体讲一下，感兴趣的小伙伴可以端碗白米饭。</p>
 <p data-pid="0RjwqgCd">首先，我们有换底公式：</p>
 <p data-pid="JbCk6BZz"><img src="https://www.zhihu.com/equation?tex=%5Cbegin%7Baligned%7D+a%5Eb+%26%3D+m+%5C%5C+%5CRightarrow+e%5E+%7B%5Cln+%7Ba%5Eb%7D%7D+%26%3D+m%5C%5C+%5CRightarrow+e%5E+%7Bb%5Cln+%7Ba%7D%7D+%26%3D+m%5C%5C+%5CRightarrow+%5Cln+e%5E%7Bb%5Cln+%7Ba%7D%7D+%26%3D+%5Cln+m%5C%5C+%5CRightarrow+%7Bb%5Cln+%7Ba%7D%7D+%26%3D+%5Cln+m%5C%5C+%5CRightarrow+b+%26%3D+%7B%5Cln+m%5Cover+%5Cln+a%7D%5C%5C+%5Cend%7Baligned%7D" alt="\begin{aligned} a^b &amp;= m \\ \Rightarrow e^ {\ln {a^b}} &amp;= m\\ \Rightarrow e^ {b\ln {a}} &amp;= m\\ \Rightarrow \ln e^{b\ln {a}} &amp;= \ln m\\ \Rightarrow {b\ln {a}} &amp;= \ln m\\ \Rightarrow b &amp;= {\ln m\over \ln a}\\ \end{aligned}" eeimg="1"></p>
 <p data-pid="7edi4Wu7">所以我们知道所有的对数函数的计算都可化为两个 <img src="https://www.zhihu.com/equation?tex=%5Cln" alt="\ln" eeimg="1"> 函数相除，比如：</p>
 <div class="highlight">
  <pre><code class="language-c"><span class="kt">double</span> <span class="nf">log10</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="c1">// log == ln
</span><span class="c1"></span><span class="p">}</span></code></pre>
 </div>
 <p data-pid="4fYygnkA">我们只需要解决如何求 <img src="https://www.zhihu.com/equation?tex=%5Cln" alt="\ln" eeimg="1"> 函数就可以了。</p>
 <p data-pid="8ctPmz4j">这才开篇进入正题！我们先看 <img src="https://www.zhihu.com/equation?tex=%5Cln" alt="\ln" eeimg="1"> 函数的实现源码（程序里面都是用 <img src="https://www.zhihu.com/equation?tex=%5Clog" alt="\log" eeimg="1"> 代替 <img src="https://www.zhihu.com/equation?tex=%5Cln" alt="\ln" eeimg="1"> 表示自然底数的对数函数）：</p>
 <div class="highlight">
  <pre><code class="language-c"><span class="cp">#include</span> <span class="cpf">"fdlibm.h"</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#ifdef __STDC__
</span><span class="cp"></span><span class="k">static</span> <span class="k">const</span> <span class="kt">double</span>
<span class="cp">#else
</span><span class="cp"></span><span class="k">static</span> <span class="kt">double</span>
<span class="cp">#endif
</span><span class="cp"></span><span class="n">ln2_hi</span>  <span class="o">=</span>  <span class="mf">6.93147180369123816490e-01</span><span class="p">,</span>	<span class="cm">/* 3fe62e42 fee00000 */</span>
<span class="n">ln2_lo</span>  <span class="o">=</span>  <span class="mf">1.90821492927058770002e-10</span><span class="p">,</span>	<span class="cm">/* 3dea39ef 35793c76 */</span>
<span class="n">two54</span>   <span class="o">=</span>  <span class="mf">1.80143985094819840000e+16</span><span class="p">,</span>  <span class="cm">/* 43500000 00000000 */</span>
<span class="n">Lg1</span> <span class="o">=</span> <span class="mf">6.666666666666735130e-01</span><span class="p">,</span>  <span class="cm">/* 3FE55555 55555593 */</span>
<span class="n">Lg2</span> <span class="o">=</span> <span class="mf">3.999999999940941908e-01</span><span class="p">,</span>  <span class="cm">/* 3FD99999 9997FA04 */</span>
<span class="n">Lg3</span> <span class="o">=</span> <span class="mf">2.857142874366239149e-01</span><span class="p">,</span>  <span class="cm">/* 3FD24924 94229359 */</span>
<span class="n">Lg4</span> <span class="o">=</span> <span class="mf">2.222219843214978396e-01</span><span class="p">,</span>  <span class="cm">/* 3FCC71C5 1D8E78AF */</span>
<span class="n">Lg5</span> <span class="o">=</span> <span class="mf">1.818357216161805012e-01</span><span class="p">,</span>  <span class="cm">/* 3FC74664 96CB03DE */</span>
<span class="n">Lg6</span> <span class="o">=</span> <span class="mf">1.531383769920937332e-01</span><span class="p">,</span>  <span class="cm">/* 3FC39A09 D078C69F */</span>
<span class="n">Lg7</span> <span class="o">=</span> <span class="mf">1.479819860511658591e-01</span><span class="p">;</span>  <span class="cm">/* 3FC2F112 DF3E5244 */</span>

<span class="k">static</span> <span class="kt">double</span> <span class="n">zero</span>   <span class="o">=</span>  <span class="mf">0.0</span><span class="p">;</span>

<span class="cp">#ifdef __STDC__
</span><span class="cp"></span>	<span class="kt">double</span> <span class="nf">__ieee754_log</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">)</span>
<span class="cp">#else
</span><span class="cp"></span>	<span class="kt">double</span> <span class="n">__ieee754_log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
	<span class="kt">double</span> <span class="n">x</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="cp"></span><span class="p">{</span>
	<span class="kt">double</span> <span class="n">hfsq</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">dk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span><span class="n">hx</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">lx</span><span class="p">;</span>

	<span class="n">hx</span> <span class="o">=</span> <span class="n">__HI</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>		<span class="cm">/* high word of x */</span>
	<span class="n">lx</span> <span class="o">=</span> <span class="n">__LO</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>		<span class="cm">/* low  word of x */</span>

	<span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hx</span> <span class="o">&lt;</span> <span class="mh">0x00100000</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* x &lt; 2**-1022  */</span>
	    <span class="k">if</span> <span class="p">(((</span><span class="n">hx</span><span class="o">&amp;</span><span class="mh">0x7fffffff</span><span class="p">)</span><span class="o">|</span><span class="n">lx</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">two54</span><span class="o">/</span><span class="n">zero</span><span class="p">;</span>		<span class="cm">/* log(+-0)=-inf */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">hx</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">zero</span><span class="p">;</span>	<span class="cm">/* log(-#) = NaN */</span>
	    <span class="n">k</span> <span class="o">-=</span> <span class="mi">54</span><span class="p">;</span> <span class="n">x</span> <span class="o">*=</span> <span class="n">two54</span><span class="p">;</span> <span class="cm">/* subnormal number, scale up x */</span>
	    <span class="n">hx</span> <span class="o">=</span> <span class="n">__HI</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>		<span class="cm">/* high word of x */</span>
	<span class="p">}</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">hx</span> <span class="o">&gt;=</span> <span class="mh">0x7ff00000</span><span class="p">)</span> <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="n">x</span><span class="p">;</span>
	<span class="n">k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">hx</span><span class="o">&gt;&gt;</span><span class="mi">20</span><span class="p">)</span><span class="o">-</span><span class="mi">1023</span><span class="p">;</span>
	<span class="n">hx</span> <span class="o">&amp;=</span> <span class="mh">0x000fffff</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">hx</span><span class="o">+</span><span class="mh">0x95f64</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x100000</span><span class="p">;</span>
	<span class="n">__HI</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">hx</span><span class="o">|</span><span class="p">(</span><span class="n">i</span><span class="o">^</span><span class="mh">0x3ff00000</span><span class="p">);</span>	<span class="cm">/* normalize x or x/2 */</span>
	<span class="n">k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span><span class="o">&gt;&gt;</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
        <span class="c1">//  到这，第一步标记，得出 k, f, s 的值了
</span><span class="c1"></span>	<span class="k">if</span><span class="p">((</span><span class="mh">0x000fffff</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="n">hx</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* |f| &lt; 2**-20 */</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">f</span><span class="o">==</span><span class="n">zero</span><span class="p">)</span> <span class="k">if</span><span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">zero</span><span class="p">;</span>  <span class="k">else</span> <span class="p">{</span><span class="n">dk</span><span class="o">=</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">k</span><span class="p">;</span>
				 <span class="k">return</span> <span class="n">dk</span><span class="o">*</span><span class="n">ln2_hi</span><span class="o">+</span><span class="n">dk</span><span class="o">*</span><span class="n">ln2_lo</span><span class="p">;}</span>
	    <span class="n">R</span> <span class="o">=</span> <span class="n">f</span><span class="o">*</span><span class="n">f</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="mf">0.33333333333333333</span><span class="o">*</span><span class="n">f</span><span class="p">);</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">f</span><span class="o">-</span><span class="n">R</span><span class="p">;</span> <span class="k">else</span> <span class="p">{</span><span class="n">dk</span><span class="o">=</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">k</span><span class="p">;</span>
	    	     <span class="k">return</span> <span class="n">dk</span><span class="o">*</span><span class="n">ln2_hi</span><span class="o">-</span><span class="p">((</span><span class="n">R</span><span class="o">-</span><span class="n">dk</span><span class="o">*</span><span class="n">ln2_lo</span><span class="p">)</span><span class="o">-</span><span class="n">f</span><span class="p">);}</span>
	<span class="p">}</span>
 	<span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">+</span><span class="n">f</span><span class="p">);</span> 
	<span class="n">dk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">k</span><span class="p">;</span>
	<span class="n">z</span> <span class="o">=</span> <span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">hx</span><span class="o">-</span><span class="mh">0x6147a</span><span class="p">;</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mh">0x6b851</span><span class="o">-</span><span class="n">hx</span><span class="p">;</span>
	<span class="n">t1</span><span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">Lg2</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">Lg4</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="n">Lg6</span><span class="p">));</span> 
	<span class="n">t2</span><span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">Lg1</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">Lg3</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">Lg5</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="n">Lg7</span><span class="p">)));</span> 
	<span class="n">i</span> <span class="o">|=</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">R</span> <span class="o">=</span> <span class="n">t2</span><span class="o">+</span><span class="n">t1</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">hfsq</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">f</span><span class="o">*</span><span class="n">f</span><span class="p">;</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">f</span><span class="o">-</span><span class="p">(</span><span class="n">hfsq</span><span class="o">-</span><span class="n">s</span><span class="o">*</span><span class="p">(</span><span class="n">hfsq</span><span class="o">+</span><span class="n">R</span><span class="p">));</span> <span class="k">else</span>
		     <span class="k">return</span> <span class="n">dk</span><span class="o">*</span><span class="n">ln2_hi</span><span class="o">-</span><span class="p">((</span><span class="n">hfsq</span><span class="o">-</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="p">(</span><span class="n">hfsq</span><span class="o">+</span><span class="n">R</span><span class="p">)</span><span class="o">+</span><span class="n">dk</span><span class="o">*</span><span class="n">ln2_lo</span><span class="p">))</span><span class="o">-</span><span class="n">f</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">f</span><span class="o">-</span><span class="n">s</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">R</span><span class="p">);</span> <span class="k">else</span>
		     <span class="k">return</span> <span class="n">dk</span><span class="o">*</span><span class="n">ln2_hi</span><span class="o">-</span><span class="p">((</span><span class="n">s</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">R</span><span class="p">)</span><span class="o">-</span><span class="n">dk</span><span class="o">*</span><span class="n">ln2_lo</span><span class="p">)</span><span class="o">-</span><span class="n">f</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre>
 </div>
 <p data-pid="yAUHdCmo">这么艹的代码，是不是看一眼就不想看了。别急，咱个儿挑重点讲。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="Yk3E4tz_"><b>1. 参数约化（Argument Reduction）</b></p>
 <p data-pid="Wp0sP94D">将输入的一个数字 <img src="https://www.zhihu.com/equation?tex=x" alt="x" eeimg="1"> 重整化为这个形式 <img src="https://www.zhihu.com/equation?tex=x%3D+2%5Ek+%5Ctimes+%281%2Bf%29" alt="x= 2^k \times (1+f)" eeimg="1"> ，其中 <img src="https://www.zhihu.com/equation?tex=%7B%5Csqrt+2%5Cover2%7D%3C%281%2Bf%29%3C%5Csqrt+2" alt="{\sqrt 2\over2}<(1+f)<\sqrt 2" eeimg="1"> . 以确保 <img src="https://www.zhihu.com/equation?tex=1%2Bf" alt="1+f" eeimg="1"> 小到足够合适，要不然之后换元的泰勒展开精度会很差。</p>
 <p data-pid="9mbiu2an">然后很容易发现规律： <img src="https://www.zhihu.com/equation?tex=%5Cln+x+%3D+%5Cln+%5B2%5Ek+%5Ctimes+%281%2Bf%29%5D+%3D+k%5Cln+2+%2B+%5Cln+%281%2Bf%29" alt="\ln x = \ln [2^k \times (1+f)] = k\ln 2 + \ln (1+f)" eeimg="1"> ，其中 <img src="https://www.zhihu.com/equation?tex=k%5Cln2" alt="k\ln2" eeimg="1"> 口算都能算出来，我们来进一步关注 <img src="https://www.zhihu.com/equation?tex=%5Cln+%281%2Bf%29" alt="\ln (1+f)" eeimg="1"> 的计算。</p>
 <p data-pid="xWQvtvok"><b>2. 计算 1+f 的对数值</b></p>
 <p data-pid="pV3rC1zF">将第一步的 <img src="https://www.zhihu.com/equation?tex=%281%2Bf%29" alt="(1+f)" eeimg="1"> 进行计算，其结果因范围控制得比较小，所以很容易近似到一个很精确的值。计算方法：</p>
 <p data-pid="gAP_DgB2">取中间代换变量 <img src="https://www.zhihu.com/equation?tex=s+%3D+%7Bf%5Cover+2+%2B+f%7D" alt="s = {f\over 2 + f}" eeimg="1"> （为什么这么代换呢？因为泰勒对 <img src="https://www.zhihu.com/equation?tex=%5Cln%28x%29" alt="\ln(x)" eeimg="1"> 函数的展开在 <img src="https://www.zhihu.com/equation?tex=x" alt="x" eeimg="1"> 接近 <img src="https://www.zhihu.com/equation?tex=1" alt="1" eeimg="1"> 的时候最好），则有泰勒展开：</p>
 <p data-pid="uGRY1wkK"><img src="https://www.zhihu.com/equation?tex=%5Cbegin%7Baligned%7D+%5Cln+%281%2Bf%29+%26%3D+%5Cln%281%2Bs%29+-+%5Cln%281-s%29%5C%5C+%26%3D2s+%2B+%7B2%5Cover3%7D+s%5E3+%2B+%7B2%5Cover5%7D+s%5E5+%2B+%5Ccdots%5C%5C+%26%3D2s+%2B+s%5Ccdot+R%28z%29+%5Cend%7Baligned%7D" alt="\begin{aligned} \ln (1+f) &amp;= \ln(1+s) - \ln(1-s)\\ &amp;=2s + {2\over3} s^3 + {2\over5} s^5 + \cdots\\ &amp;=2s + s\cdot R(z) \end{aligned}" eeimg="1"></p>
 <p data-pid="dUDdkv1r">我们用一个 Remez 算法来求解 <img src="https://www.zhihu.com/equation?tex=R%28z%29" alt="R(z)" eeimg="1"> （具体参考百科 <a href="https://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E9%259B%25B7%25E7%25B1%25B3%25E8%258C%25B2%25E6%25BC%2594%25E7%25AE%2597%25E6%25B3%2595" class=" wrap external" target="_blank" rel="nofollow noreferrer">Remez算法</a> ），逼近到 14 次方项，此时的精度可以到 <img src="https://www.zhihu.com/equation?tex=2%5E%7B-58.45%7D" alt="2^{-58.45}" eeimg="1"> 这个级别，完全足够满足 64 位浮点运算要求了，于是上式的 <img src="https://www.zhihu.com/equation?tex=R" alt="R" eeimg="1"> 就可以等于：</p>
 <p data-pid="e1oRBz8E"><img src="https://www.zhihu.com/equation?tex=R%28z%29%5Capprox+Lg1%5Ccdot+s+%2BLg2%5Ccdot+s+%2BLg3%5Ccdot+s+%2BLg4%5Ccdot+s+%2BLg5%5Ccdot+s++%2BLg6%5Ccdot+s++%2BLg7%5Ccdot+s" alt="R(z)\approx Lg1\cdot s +Lg2\cdot s +Lg3\cdot s +Lg4\cdot s +Lg5\cdot s  +Lg6\cdot s  +Lg7\cdot s" eeimg="1"></p>
 <p data-pid="NEoTPz59">其中每一项 <img src="https://www.zhihu.com/equation?tex=s" alt="s" eeimg="1"> 都需要带对应指数，式子可满足精度 <img src="https://www.zhihu.com/equation?tex=%7C%28Lg1%5Ccdot+s+%2B+%5Ccdots+%2BLg7%5Ccdot+s%29+-+R%28z%29%7C%3C+2%5E%7B-58.45%7D" alt="|(Lg1\cdot s + \cdots +Lg7\cdot s) - R(z)|< 2^{-58.45}" eeimg="1"> ，且 <img src="https://www.zhihu.com/equation?tex=Lgi%2C%5C+i+%3D+1%2C2%2C...%2C7" alt="Lgi,\ i = 1,2,...,7" eeimg="1"> 都是常数，从上面的代码可以看到这些常数的值。</p>
 <p data-pid="wE5Zkdn4">然后根据 <img src="https://www.zhihu.com/equation?tex=s+%3D+%7Bf%5Cover+2+%2B+f%7D" alt="s = {f\over 2 + f}" eeimg="1"> ，我们有进一步的代换关系： <img src="https://www.zhihu.com/equation?tex=2s+%3D+%7B2f%5Cover+2+%2B+f%7D+%3D+f-sf" alt="2s = {2f\over 2 + f} = f-sf" eeimg="1"></p>
 <p data-pid="vvlGJHgS">于是有：</p>
 <p data-pid="IK7yeNHG"><img src="https://www.zhihu.com/equation?tex=%5Cbegin%7Baligned%7D+%5Cln+%281%2Bf%29+%26%3D+2s+%2B+s%5Ccdot+R%28z%29+%5C%5C+%26%3D+f-sf+%2B+s%5Ccdot+R%28z%29+%5C%5C+%26%3Df+-+s%28f-R%28z%29%29+%5Cend%7Baligned%7D" alt="\begin{aligned} \ln (1+f) &amp;= 2s + s\cdot R(z) \\ &amp;= f-sf + s\cdot R(z) \\ &amp;=f - s(f-R(z)) \end{aligned}" eeimg="1"></p>
 <p data-pid="kAWZTNiE">则：</p>
 <p data-pid="JRGwavfx"><img src="https://www.zhihu.com/equation?tex=%5Cln%28x%29+%3D+k%5Cln+2+%2B+%5Cln+%281%2Bf%29+%3D+k%5Cln2+%2B+f+-+s%28f-R%28z%29%29" alt="\ln(x) = k\ln 2 + \ln (1+f) = k\ln2 + f - s(f-R(z))" eeimg="1"></p>
 <p data-pid="84LFknCY">另外，如果要求更高精度的话，重复代换关系可得： <img src="https://www.zhihu.com/equation?tex=2s+%3D+f-sf+%3D+f+-+%7Bff%5Cover2%7D+%2B+%7Bsff%5Cover2%7D" alt="2s = f-sf = f - {ff\over2} + {sff\over2}" eeimg="1"></p>
 <p data-pid="ekzyGOtl">于是有：</p>
 <p data-pid="V9bo3Km4"><img src="https://www.zhihu.com/equation?tex=%5Cbegin%7Baligned%7D+%5Cln+%281%2Bf%29+%26%3D+2s+%2B+s%5Ccdot+R%28z%29+%5C%5C+%26%3D+f+-+%7Bff%5Cover2%7D+%2B+%7Bsff%5Cover2%7D+%2B+s%5Ccdot+R%28z%29+%5C%5C+%26%3Df+-+%7Bff%5Cover2%7D++%2B+s%28%5Cfrac%7Bff%7D%7B2%7D%2BR%28z%29%29+%5Cend%7Baligned%7D" alt="\begin{aligned} \ln (1+f) &amp;= 2s + s\cdot R(z) \\ &amp;= f - {ff\over2} + {sff\over2} + s\cdot R(z) \\ &amp;=f - {ff\over2}  + s(\frac{ff}{2}+R(z)) \end{aligned}" eeimg="1"></p>
 <p data-pid="Y4ILw4-5">则：</p>
 <p data-pid="wueliXWu"><img src="https://www.zhihu.com/equation?tex=%5Cln%28x%29+%3D+k%5Cln+2+%2B+%5Cln+%281%2Bf%29+%3D+k%5Cln2+%2B+f+-+%7Bff%5Cover2%7D++%2B+s%28%5Cfrac%7Bff%7D%7B2%7D%2BR%28z%29%29" alt="\ln(x) = k\ln 2 + \ln (1+f) = k\ln2 + f - {ff\over2}  + s(\frac{ff}{2}+R(z))" eeimg="1"></p>
 <p data-pid="ghQN895K">总览一下：其中的 <img src="https://www.zhihu.com/equation?tex=%5Cln2" alt="\ln2" eeimg="1"> 是个常数， <img src="https://www.zhihu.com/equation?tex=R%28z%29" alt="R(z)" eeimg="1"> 项也是通过 7 个常数和 <img src="https://www.zhihu.com/equation?tex=s" alt="s" eeimg="1"> 的值计算得到的，所以这个方法依赖了 8 个常数和 3 个变量 <img src="https://www.zhihu.com/equation?tex=k%2Cs%2Cf" alt="k,s,f" eeimg="1"> ，变量关系为 <img src="https://www.zhihu.com/equation?tex=x%3D+2%5Ek+%5Ctimes+%281%2Bf%29" alt="x= 2^k \times (1+f)" eeimg="1"> ， <img src="https://www.zhihu.com/equation?tex=s+%3D+%7Bf%5Cover+2+%2B+f%7D" alt="s = {f\over 2 + f}" eeimg="1"> .</p>
 <p data-pid="Lqe-hfpW">上面的代码看起来复杂，但核心也就这些，多的都是些边界判断，比如 <img src="https://www.zhihu.com/equation?tex=x" alt="x" eeimg="1"> 是不是 <img src="https://www.zhihu.com/equation?tex=0" alt="0" eeimg="1"> ， <img src="https://www.zhihu.com/equation?tex=f" alt="f" eeimg="1"> 算出来的 <img src="https://www.zhihu.com/equation?tex=R" alt="R" eeimg="1"> 的精度符不符合要求这类。如果感兴趣的话建议抽时间自己再手动实现一遍以加深印象，指不定哪天就用上了呢。</p>
 <p data-pid="WARmoUyr">======= updated: 2022-11-28 =======</p>
 <p data-pid="c9QMLFzM">一年多来这个回答收到了很多赞，看来大家对计算机+数学都是真爱，刚好前两天顺道看到 Go 的源码，发现里面的 <code>log</code> 实现得更“可读”，于是贴出来给大家参考参考：</p>
 <div class="highlight">
  <pre><code class="language-go"><span class="kd">func</span> <span class="nf">log</span><span class="p">(</span><span class="nx">x</span> <span class="kt">float64</span><span class="p">)</span> <span class="kt">float64</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="p">(</span>
		<span class="nx">Ln2Hi</span> <span class="p">=</span> <span class="mf">6.93147180369123816490e-01</span> <span class="cm">/* 3fe62e42 fee00000 */</span>
		<span class="nx">Ln2Lo</span> <span class="p">=</span> <span class="mf">1.90821492927058770002e-10</span> <span class="cm">/* 3dea39ef 35793c76 */</span>
		<span class="nx">L1</span>    <span class="p">=</span> <span class="mf">6.666666666666735130e-01</span>   <span class="cm">/* 3FE55555 55555593 */</span>
		<span class="nx">L2</span>    <span class="p">=</span> <span class="mf">3.999999999940941908e-01</span>   <span class="cm">/* 3FD99999 9997FA04 */</span>
		<span class="nx">L3</span>    <span class="p">=</span> <span class="mf">2.857142874366239149e-01</span>   <span class="cm">/* 3FD24924 94229359 */</span>
		<span class="nx">L4</span>    <span class="p">=</span> <span class="mf">2.222219843214978396e-01</span>   <span class="cm">/* 3FCC71C5 1D8E78AF */</span>
		<span class="nx">L5</span>    <span class="p">=</span> <span class="mf">1.818357216161805012e-01</span>   <span class="cm">/* 3FC74664 96CB03DE */</span>
		<span class="nx">L6</span>    <span class="p">=</span> <span class="mf">1.531383769920937332e-01</span>   <span class="cm">/* 3FC39A09 D078C69F */</span>
		<span class="nx">L7</span>    <span class="p">=</span> <span class="mf">1.479819860511658591e-01</span>   <span class="cm">/* 3FC2F112 DF3E5244 */</span>
	<span class="p">)</span>

	<span class="c1">// special cases
</span><span class="c1"></span>	<span class="k">switch</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nf">IsNaN</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">||</span> <span class="nf">IsInf</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
		<span class="k">return</span> <span class="nx">x</span>
	<span class="k">case</span> <span class="nx">x</span> <span class="p">&lt;</span> <span class="mi">0</span><span class="p">:</span>
		<span class="k">return</span> <span class="nf">NaN</span><span class="p">()</span>
	<span class="k">case</span> <span class="nx">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="k">return</span> <span class="nf">Inf</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// reduce
</span><span class="c1"></span>	<span class="nx">f1</span><span class="p">,</span> <span class="nx">ki</span> <span class="o">:=</span> <span class="nf">Frexp</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">f1</span> <span class="p">&lt;</span> <span class="nx">Sqrt2</span><span class="o">/</span><span class="mi">2</span> <span class="p">{</span>
		<span class="nx">f1</span> <span class="o">*=</span> <span class="mi">2</span>
		<span class="nx">ki</span><span class="o">--</span>
	<span class="p">}</span>
	<span class="nx">f</span> <span class="o">:=</span> <span class="nx">f1</span> <span class="o">-</span> <span class="mi">1</span>
	<span class="nx">k</span> <span class="o">:=</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">ki</span><span class="p">)</span>

	<span class="c1">// compute
</span><span class="c1"></span>	<span class="nx">s</span> <span class="o">:=</span> <span class="nx">f</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">f</span><span class="p">)</span>
	<span class="nx">s2</span> <span class="o">:=</span> <span class="nx">s</span> <span class="o">*</span> <span class="nx">s</span>
	<span class="nx">s4</span> <span class="o">:=</span> <span class="nx">s2</span> <span class="o">*</span> <span class="nx">s2</span>
	<span class="nx">t1</span> <span class="o">:=</span> <span class="nx">s2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">L1</span> <span class="o">+</span> <span class="nx">s4</span><span class="o">*</span><span class="p">(</span><span class="nx">L3</span><span class="o">+</span><span class="nx">s4</span><span class="o">*</span><span class="p">(</span><span class="nx">L5</span><span class="o">+</span><span class="nx">s4</span><span class="o">*</span><span class="nx">L7</span><span class="p">)))</span>
	<span class="nx">t2</span> <span class="o">:=</span> <span class="nx">s4</span> <span class="o">*</span> <span class="p">(</span><span class="nx">L2</span> <span class="o">+</span> <span class="nx">s4</span><span class="o">*</span><span class="p">(</span><span class="nx">L4</span><span class="o">+</span><span class="nx">s4</span><span class="o">*</span><span class="nx">L6</span><span class="p">))</span>
	<span class="nx">R</span> <span class="o">:=</span> <span class="nx">t1</span> <span class="o">+</span> <span class="nx">t2</span>
	<span class="nx">hfsq</span> <span class="o">:=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nx">f</span> <span class="o">*</span> <span class="nx">f</span>
	<span class="k">return</span> <span class="nx">k</span><span class="o">*</span><span class="nx">Ln2Hi</span> <span class="o">-</span> <span class="p">((</span><span class="nx">hfsq</span> <span class="o">-</span> <span class="p">(</span><span class="nx">s</span><span class="o">*</span><span class="p">(</span><span class="nx">hfsq</span><span class="o">+</span><span class="nx">R</span><span class="p">)</span> <span class="o">+</span> <span class="nx">k</span><span class="o">*</span><span class="nx">Ln2Lo</span><span class="p">))</span> <span class="o">-</span> <span class="nx">f</span><span class="p">)</span>
<span class="p">}</span> 
</code></pre>
 </div>
 <p data-pid="jUX5H3h_">算法还是同C一样的，这次看完相信大家一定能手写了！</p>
</body>