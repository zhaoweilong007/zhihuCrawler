# 一个程序员的水平能差到什么程度?
- 点赞数：19118
- 更新时间：2021年03月17日08时48分09秒
- 回答url：https://www.zhihu.com/question/314644210/answer/1758421083
<body>
 <p data-pid="LaZ14l19"><b>大概就是，一个if循环19.8亿次，而且7年没人敢动....</b></p>
 <p data-pid="ol3i8gx1">真事，就出现在知名游戏大厂R星的知名大作 <b>GTA 5</b> 中。</p>
 <p data-pid="E0Y0UqwX">而且，19.8亿次的if循环，今天仍然在世界各地的玩家cpu上跑着。</p>
 <p data-pid="iJPpWCyQ">————————————————————————————————————————————<br>
  3月16日更新：</p>
 <p data-pid="I62HRPfu">GTA 5“屎山”代码后续来了。</p>
 <p data-pid="ehZiKf-y">R星终于官宣准备修复了！</p>
 <p data-pid="9MbPRwzf">主动改善玩家游戏体验？不存在的。</p>
 <p data-pid="1MPph-sI">要主动，哪里还要等七年？</p>
 <p data-pid="-3SLLQ49">这篇揭R星老底的帖子在全网大火后，R星不得不出面应对。</p>
 <p data-pid="6DvZun69">在和黑客大哥联系后，R星认可了他的改进方法，宣布在后续更新中修复相关问题，并且还慷慨的给他付了一笔<b>1万美元</b>的奖金。</p>
 <figure data-size="normal">
  <img src="https://pica.zhimg.com/50/v2-77a66dccdbd2bc9cd4bf8e292b8d59a2_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="317" data-original-token="v2-77a66dccdbd2bc9cd4bf8e292b8d59a2" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://picx.zhimg.com/v2-77a66dccdbd2bc9cd4bf8e292b8d59a2_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="7BgRHi8z">鉴于R星失误实在太低级太离谱，而这位老哥的方法又太有效，以致无数玩家称他“功德无量”。</p>
 <blockquote data-pid="1eyJ3uHe">
  如果平均给每个玩家节省10秒，全球500万玩家一天就能节约5000万秒，一年中，节约的总时间大概能有数十年。相当于挽救了十多个人的生命！
 </blockquote>
 <p data-pid="9ZfUbIv1">“事了拂衣去，不留功与名”，这位黑客大哥被无数玩家膜拜。当然大家也不忘再把R星拖出来“鞭尸”。</p>
 <p data-pid="Un61XCrz">有人吐槽，GTA 5仅2020年就买了2000万份，累计销量更是达到1.4亿份，R星每年都能从这个项目上赚数亿美元，但是却不肯花几分钟去解决这么一个低级错误，实在可耻。</p>
 <figure data-size="normal">
  <img src="https://picx.zhimg.com/50/v2-4b12aa5d81120b779e0224c6d0d62c51_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="151" data-original-token="v2-4b12aa5d81120b779e0224c6d0d62c51" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://picx.zhimg.com/v2-4b12aa5d81120b779e0224c6d0d62c51_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="YNk6i5cA">还有人抨击R星几乎从不与玩家社区互动，玩家提的意见也从来充耳不闻，直到这次被被黑客嘲讽打脸，才不得不出来表态。</p>
 <p data-pid="hNoEV8B1">事后，黑客大哥还透露了一丝身份信息，原来他人在拉脱维亚。</p>
 <p data-pid="eZnkIGzI">拉脱维亚是波罗的海国家，原来是前苏联加盟国之一。在网上搜索相关信息，可以发现“拉脱维亚黑客”，几乎是和俄罗斯黑客一样传奇神秘的存在。</p>
 <figure data-size="normal">
  <img src="https://pic1.zhimg.com/50/v2-1a734a662faeb9cab9dbb6add9827f22_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1248" data-rawheight="800" data-original-token="v2-1a734a662faeb9cab9dbb6add9827f22" class="origin_image zh-lightbox-thumb" width="1248" data-original="https://pic1.zhimg.com/v2-1a734a662faeb9cab9dbb6add9827f22_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="13T3cbxX">有网友爆料，在拉脱维亚，普通程序员工资平均3-4k欧元（23000-31000人民币）。</p>
 <p data-pid="WsHzfc2R">而他领到的这1万美元奖金，相当于三四个月工资了。</p>
 <p data-pid="5BmWdH7L">提前领了一笔“年终奖”，黑客大哥表示很开心。同时他也说，将密切关注GTA 5未来更新，一丝不苟的检查修复情况。</p>
 <p data-pid="70wV7lDb">不知道他还能不能从R星领走更多奖金</p>
 <p data-pid="boJxYe14">（注：所谓“屎山”，是程序员间流传的一个梗，指陈年累月且复杂低效的代码，因为改动成本巨大，所有人避之不及。）</p>
 <p data-pid="v5gMMVm7">——————————————————————————————————————————</p>
 <p data-pid="mypkQgP0">GTA 5“屎山代码”前情回顾：</p>
 <p data-pid="H9mWHbAP">一支烟的功夫，<b>GTA 5联机版</b>终于打开了。<br><br></p>
 <figure data-size="normal">
  <img src="https://picx.zhimg.com/50/v2-2a2b27671d068f5cf1f03c3879554b99_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="153" data-original-token="v2-2a2b27671d068f5cf1f03c3879554b99" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://picx.zhimg.com/v2-2a2b27671d068f5cf1f03c3879554b99_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="4wfm79xW"><br>
  「7年了！GTA 5联机版加载还是这么慢？？」<br><br></p>
 <figure data-size="normal">
  <img src="https://pic1.zhimg.com/50/v2-8b56ed518084fba19914832a348fd3d8_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="708" data-rawheight="398" data-original-token="v2-8b56ed518084fba19914832a348fd3d8" class="origin_image zh-lightbox-thumb" width="708" data-original="https://picx.zhimg.com/v2-8b56ed518084fba19914832a348fd3d8_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="Qv-h2QVN"><br><b>△</b>Please wait forever to play<br>
  Reddit、Steam、HackerNews上，无数玩家吐槽抱怨……<br>
  进游戏少则等5、6分钟，多则20分钟。<br>
  终于，一个黑客大哥实在忍不了，用逆编译器逐条查看运行情况，终于找到原因。<br>
  原来，R星（游戏开发商RockStar）写的代码太低效，加载时，一个if语句竟然循环了19.8亿次….<br><b>幕后黑手：谁占用大量时间？</b><br>
  加载GTA 5 Online到底有多慢？<br><br></p>
 <figure data-size="normal">
  <img src="https://picx.zhimg.com/50/v2-59d116b2f06237bfb794102f72e45b56_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="973" data-rawheight="405" data-original-token="v2-59d116b2f06237bfb794102f72e45b56" class="origin_image zh-lightbox-thumb" width="973" data-original="https://pica.zhimg.com/v2-59d116b2f06237bfb794102f72e45b56_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="-YutNuXm"><br><b>△</b>硬件拉满的土豪玩家请无视<br>
  Reddit相关板块发起的调查中，超过80%的玩家，都要等3分钟以上，有的甚至超过15分钟。<br>
  而且，从7年前Online上线到今天，这个情况丝毫没有改善。<br>
  暴躁的，已经骂起了脏话……<br><br></p>
 <figure data-size="normal">
  <img src="https://picx.zhimg.com/50/v2-cece85ba8704cc4a7a4fc60faddd959c_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="330" data-original-token="v2-cece85ba8704cc4a7a4fc60faddd959c" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://picx.zhimg.com/v2-cece85ba8704cc4a7a4fc60faddd959c_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="0Awq5A6x"><br>
  但奇怪的是，如果你选择是故事模式（单机版），加载就会快很多，感觉甚至像两个不同的工作室开发的游戏。<br>
  具体到这位黑客大哥的例子，他自己的硬件配置如下：<br><br></p>
 <figure data-size="normal">
  <img src="https://pic1.zhimg.com/50/v2-b8aa2c1db8d5a6cd76dc92aade52cc01_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="281" data-original-token="v2-b8aa2c1db8d5a6cd76dc92aade52cc01" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic1.zhimg.com/v2-b8aa2c1db8d5a6cd76dc92aade52cc01_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="DMDAGHfQ"><br>
  CPU，是老而弥坚的AMD FX-8350，2012年上市，采用“推土机”架构，超频潜力惊人。<br>
  显卡还是GTX 1070。<br>
  这样今天看起来老旧的配置，打开单机版GTA 5需要1分10秒，而加载联机版则6分钟起。<br>
  黑客大哥用了最简单的Windows任务管理器，来判断联机版GTA 5在启动时，都调用了哪些计算机资源。<br><br></p>
 <figure data-size="normal">
  <img src="https://picx.zhimg.com/50/v2-ba8167d56deecd0691aea25d45454476_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="602" data-original-token="v2-ba8167d56deecd0691aea25d45454476" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://picx.zhimg.com/v2-ba8167d56deecd0691aea25d45454476_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="q3ZFgN1e"><br>
  在1分钟的时间分界线上，之前是加载的是单机和联机版通用的基础内容，之后是联机版独有的内容。<br>
  可以看到，联机版GTA 5，加载时调用大量CPU资源至少长达4分钟之久。<br>
  而同时，内存、GPU、硬盘的使用情况几乎没有明显变化。<br>
  所以，问题大概率出在代码上。<br><b>“R星代码写太烂！”</b><br>
  黑客大哥在开扒R星代码之前，就说：<br>
  我闻到一股烂代码的味道…..<br>
  为了找出到底那一部分程序卡住了CPU，他使用了工具<b>Luke Stackwalker</b>，对CPU任务堆栈进行采样分析。<br>
  Luke Stackwalker对于闭源应用程序，可以转存正在运行的进程堆栈，和当前指令指针的位置，以一定时间间隔建立一个调用树。<br>
  最后将数据整合，就可以得到程序运行统计数据。<br>
  从结果上看，一共有两个函数“卡住”了CPU：<br><br></p>
 <figure data-size="normal">
  <img src="https://pic1.zhimg.com/50/v2-36aa16b41b2031ac9d7e8502c646b254_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="974" data-rawheight="451" data-original-token="v2-36aa16b41b2031ac9d7e8502c646b254" class="origin_image zh-lightbox-thumb" width="974" data-original="https://pica.zhimg.com/v2-36aa16b41b2031ac9d7e8502c646b254_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="Q--GjKgw"><br>
  于是他使用专业的代码拆解工具，给GTA 5来了一个“开膛破肚”。<br>
  沿着调用栈往下走，发现问题出在一个<b>sscanf</b>函数上。<br><br></p>
 <figure data-size="normal">
  <img src="https://picx.zhimg.com/50/v2-1b5e1a88ee2644d84574e1f1678030fc_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="854" data-rawheight="461" data-original-token="v2-1b5e1a88ee2644d84574e1f1678030fc" class="origin_image zh-lightbox-thumb" width="854" data-original="https://picx.zhimg.com/v2-1b5e1a88ee2644d84574e1f1678030fc_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="poT6aY0X"><br>
  sscanf的功能是读取格式化的字符串中的数据，而在GTA 5中，它正在读取的是一个10M左右，有63000多个条目的JSON文件。<br>
  这个文件到底是干什么用的？黑客大哥推测，这可能是<b>游戏内购商店的相关内容。</b><br><br></p>
 <figure data-size="normal">
  <img src="https://pica.zhimg.com/50/v2-2c588891f985b2fb79470772a2039202_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="504" data-original-token="v2-2c588891f985b2fb79470772a2039202" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pica.zhimg.com/v2-2c588891f985b2fb79470772a2039202_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="zGWWdR07"><br>
  在具体运行时，sscanf对于每个有效值，逐个读取每一个字符，然后返回结果，之后指针移向下一个值，循环往复……直到把10M文件全部扫一遍。<br>
  再看第二个问题，这是一个存储命令，对象是<b>item</b>，具体是什么不得而知。<br>
  但是保存前，有一个if语句，逐一比较item内项目的哈希值，检查它们是否出现在某一列表中。<br>
  按照他的计算，这一步if，要执行(63000^2+63000)/2 = <b>1984531500</b>次！<br>
  没错，等待加载前的十多分钟里，GTA 5用你的CPU，执行了19.8亿次if命令。<br><br></p>
 <figure data-size="normal">
  <img src="https://pica.zhimg.com/50/v2-8fded089437b90199f9aecf4ac091d8b_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="64" data-rawheight="64" data-original-token="v2-8fded089437b90199f9aecf4ac091d8b" class="content_image" width="64">
 </figure>
 <p data-pid="IWMum06A"><br>
  如此简单粗暴的编程思路，让这位老哥哭笑不得：<br>
  既然对象有唯一哈希值，那为什么不用<b>hash map</b>？？？<br><br><br></p>
 <figure data-size="normal">
  <img src="https://pic1.zhimg.com/50/v2-707e83fad7d3be68909a2a7bd70b675d_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="700" data-rawheight="933" data-original-token="v2-707e83fad7d3be68909a2a7bd70b675d" class="origin_image zh-lightbox-thumb" width="700" data-original="https://pic1.zhimg.com/v2-707e83fad7d3be68909a2a7bd70b675d_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="K5t5NxBY"><br>
  （hashmap根据hashCode值存储数据，大多数情况下可以直接定位到它的值，因而具有很快的访问速度，但遍历顺序不确定。）</p>
 <p data-pid="1ji22yQo">至于为什么这样，有网友推测最开始，if的循环次数并没有这么多，而是随着开发，条目不断增多，最后到了积重难返的地步。</p>
 <p data-pid="6ws1EMPi">而之前的代码结构，谁也不愿意去动。</p>
 <p data-pid="hxPqwTP_">就这样，19.8亿次if，一遍遍在世界各地玩家cpu上上演。。。</p>
 <p data-pid="KMdmKVJb">这是不是堪称游戏开发史上最意外的“屎山”代码？</p>
 <p data-pid="q_XGjBfc"><br><b>问题解决，加载时间节省70%</b><br>
  至于第一个问题，黑客大哥采用hook大法，不一一读取字符串，而是：<br>
  hook strlen<br>
  “缓存 “字符串起始和当前长度。<br>
  如果在字符串范围内函数在此被调用，返回缓存的值<br>
  至于if语句问题，就更直接了——完全跳过重复检查，利用hash map插入项目，因为这些值是唯一的。<br>
  最后的结果如下：<br><br></p>
 <figure data-size="normal">
  <img src="https://picx.zhimg.com/50/v2-5c5271ca6c2d478b19bfdcdfc65c1eb1_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="276" data-original-token="v2-5c5271ca6c2d478b19bfdcdfc65c1eb1" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic1.zhimg.com/v2-5c5271ca6c2d478b19bfdcdfc65c1eb1_r.jpg?source=1940ef5c">
 </figure>
 <p data-pid="EXJifrKL"><br>
  现在，GTA 5联机版加载，从原来的6分钟，下降到现在的1分50秒！而且，用的还是七八年前的硬件配置。<br>
  在此，应该手动@R星：你学废了吗？<br><br></p>
 <figure data-size="normal">
  <img src="https://pic1.zhimg.com/50/v2-5fd37ab2c7952180f67c882714b94071_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="64" data-rawheight="64" data-original-token="v2-5fd37ab2c7952180f67c882714b94071" class="content_image" width="64">
 </figure>
 <p data-pid="csUsGRsW"><br>
  这位黑客大哥在博文中没有留下任何身份信息，也没有透露用的反编译工具，但是做好事不留名的他，把打好包的工具上传到了Github，玩家通过一行代码就能下载：</p>
 <p data-pid="k4y21RnZ"><br>
  git clone —recurse-submodules <a href="https://link.zhihu.com/?target=https%3A//github.com/tostercx/GTAO_Booster_PoC" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/tostercx/GTA</span><span class="invisible">O_Booster_PoC</span><span class="ellipsis"></span></a></p>
 <p data-pid="aOmUe5Oa"><br>
  之后，把dll文件粘贴到游戏根目录下就OK！<br><i>博客原文</i><br><br><i><a href="https://link.zhihu.com/?target=https%3A//nee.lv/2021/02/28/How-I-cut-GTA-Online-loading-times-by-70/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">nee.lv/2021/02/28/How-I</span><span class="invisible">-cut-GTA-Online-loading-times-by-70/</span><span class="ellipsis"></span></a></i><br><i>Github地址：</i><br><br><i><a href="https://link.zhihu.com/?target=https%3A//github.com/tostercx/GTAO_Booster_PoC" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/tostercx/GTA</span><span class="invisible">O_Booster_PoC</span><span class="ellipsis"></span></a></i></p>
</body>