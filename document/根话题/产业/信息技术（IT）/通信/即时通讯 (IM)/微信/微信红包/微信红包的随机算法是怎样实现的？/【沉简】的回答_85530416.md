# 微信红包的随机算法是怎样实现的？
- 点赞数：5527
- 更新时间：2020年09月21日19时52分52秒
- 回答url：https://www.zhihu.com/question/22625187/answer/85530416
<body>
 <p data-pid="AaKYzfHY"><b>有人问过微信的人，大致是这样：</b></p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="DeHOpRVb">先上代码：</p>
 <p class="ztext-empty-paragraph"><br></p>
 <div class="highlight">
  <pre><code class="language-text">public static double getRandomMoney(RedPackage _redPackage) {
    // remainSize 剩余的红包数量
    // remainMoney 剩余的钱
    if (_redPackage.remainSize == 1) {
        _redPackage.remainSize--;
        return (double) Math.round(_redPackage.remainMoney * 100) / 100;
    }
    Random r     = new Random();
    double min   = 0.01; //
    double max   = _redPackage.remainMoney / _redPackage.remainSize * 2;
    double money = r.nextDouble() * max;
    money = money &lt;= min ? 0.01: money;
    money = Math.floor(money * 100) / 100;
    _redPackage.remainSize--;
    _redPackage.remainMoney -= money;
    return money;
}
</code></pre>
 </div>
 <p data-pid="ihGu8xtj"><b>以上代码仅供参考，涉及商业计算要用java.math.BigDecimal</b>. 感谢 <a class="member_mention" href="https://www.zhihu.com/people/db08942ad6d7e6a95af8f1a38921ccd6" data-hash="db08942ad6d7e6a95af8f1a38921ccd6" data-hovercard="p$b$db08942ad6d7e6a95af8f1a38921ccd6">@xin lu</a>、 <a class="member_mention" href="https://www.zhihu.com/people/b489b03142b2f1ca6f75d7df1fe0c79b" data-hash="b489b03142b2f1ca6f75d7df1fe0c79b" data-hovercard="p$b$b489b03142b2f1ca6f75d7df1fe0c79b">@秦时明月</a> 指出。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="sakzI2w4"><b>再说结论：</b></p>
 <ol>
  <li data-pid="eeOWUXbr">先抢后抢拿到红包的大小的期望是大致相等的，所以还是先下手抢吧</li>
  <li data-pid="ONW4POUW">后抢的人方差大（依赖前面人抢的多少），波动较大，有较大几率拿到“<b>手气最佳</b>”</li>
 </ol>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="clSz0iZn"><b>祝大家抢红包快乐哦~</b></p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="IzNPZ2xC"><b>测试数据。</b></p>
 <p data-pid="Z1RG08Ac">测试结果测试随机红包</p>
 <p data-pid="gjPWN5xI">以上面的初始化数据（30人抢500块），执行了两次，结果如下：</p>
 <p class="ztext-empty-paragraph"><br></p>
 <div class="highlight">
  <pre><code class="language-text">// 第一次
15.69    21.18    24.11    30.85    0.74    20.85    2.96    13.43    11.12    24.87    1.86    19.62    5.97    29.33    3.05    26.94    18.69    34.47    9.4    29.83    5.17    24.67    17.09    29.96    6.77    5.79    0.34    23.89    40.44    0.92

// 第二次
10.44    18.01    17.01    21.07    11.87    4.78    30.14    32.05    16.68    20.34    12.94    27.98    9.31    17.97    12.93    28.75    12.1    12.77    7.54    10.87    4.16    25.36    26.89    5.73    11.59    23.91    17.77    15.85    23.42    9.77
</code></pre>
 </div>
 <p data-pid="CHzoaWid">对应图表如下：<br></p>
 <p class="ztext-empty-paragraph"><br></p>
 <figure data-size="normal">
  <img src="https://pic1.zhimg.com/50/383a5c9dd7451db4d1bde8f59dcc66fb_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="835" data-rawheight="523" data-original-token="383a5c9dd7451db4d1bde8f59dcc66fb" class="origin_image zh-lightbox-thumb" width="835" data-original="https://pic1.zhimg.com/383a5c9dd7451db4d1bde8f59dcc66fb_r.jpg?source=1940ef5c">
 </figure>
 <p class="ztext-empty-paragraph"><br></p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="UXGL3Pkx">还有一张：</p>
 <figure data-size="normal">
  <img src="https://pic1.zhimg.com/50/f3db54ba944f208ed8917651cbb7ce70_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="833" data-rawheight="518" data-original-token="f3db54ba944f208ed8917651cbb7ce70" class="origin_image zh-lightbox-thumb" width="833" data-original="https://picx.zhimg.com/f3db54ba944f208ed8917651cbb7ce70_r.jpg?source=1940ef5c">
 </figure>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="cwufPRbS">多次均值</p>
 <p data-pid="37USlxLC">200次</p>
 <figure data-size="normal">
  <img src="https://picx.zhimg.com/50/90c57b9fed9398b866e636a910e8f86d_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1325" data-rawheight="751" data-original-token="90c57b9fed9398b866e636a910e8f86d" class="origin_image zh-lightbox-thumb" width="1325" data-original="https://picx.zhimg.com/90c57b9fed9398b866e636a910e8f86d_r.jpg?source=1940ef5c">
 </figure>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="UVW-DyDS">2000次</p>
 <figure data-size="normal">
  <img src="https://picx.zhimg.com/50/9c9d0c51d6528c2ac6ae599a640c271c_720w.jpg?source=1940ef5c" data-caption="" data-size="normal" data-rawwidth="1328" data-rawheight="750" data-original-token="9c9d0c51d6528c2ac6ae599a640c271c" class="origin_image zh-lightbox-thumb" width="1328" data-original="https://picx.zhimg.com/9c9d0c51d6528c2ac6ae599a640c271c_r.jpg?source=1940ef5c">
 </figure>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="GCClb9RX"><b>可以看到，这个算法可以让大家抢到的红包面额在概率上是大致均匀的。</b></p>
 <p class="ztext-empty-paragraph"><br></p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="URGtKcVJ">转一下原文</p>
 <p data-pid="7a5Je8QU"><b>微信红包的架构设计简介</b></p>
 <p data-pid="uu9v4LBj"><b>@来源于QCon某高可用架构群整理，整理朱玉华。</b></p>
 <blockquote data-pid="eO98QQj-">
  <b>背景：有某个朋友在朋友圈咨询微信红包的架构，于是乎有了下面的文字（有误请提出，谢谢）</b>
 </blockquote>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="0oBvAMgg"><b>概况：</b>2014年微信红包使用数据库硬抗整个流量，2015年使用cache抗流量。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="_lHlxf7W"><b>1. 微信的金额什么时候算？</b></p>
 <p data-pid="1iscsj-z">答：微信金额是拆的时候实时算出来，不是预先分配的，采用的是纯内存计算，不需要预算空间存储。<br>
  采取实时计算金额的考虑：预算需要占存储，实时效率很高，预算才效率低。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="XhjCSfhx"><b>2. 实时性：为什么明明抢到红包，点开后发现没有？</b></p>
 <p data-pid="DqXDXDWX">答：2014年的红包一点开就知道金额，分两次操作，先抢到金额，然后再转账。<br>
  2015年的红包的拆和抢是分离的，需要点两次，因此会出现抢到红包了，但点开后告知红包已经被领完的状况。进入到第一个页面不代表抢到，只表示当时红包还有。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="HYl2f7s1"><b>3. 分配：红包里的金额怎么算？为什么出现各个红包金额相差很大？</b></p>
 <p data-pid="vBgLDcjY">答：随机，额度在0.01和(剩余平均值*2)之间。<br>
  例如：发100块钱，总共10个红包，那么平均值是10块钱一个，那么发出来的红包的额度在0.01元～20元之间波动。<br>
  当前面3个红包总共被领了40块钱时，剩下60块钱，总共7个红包，那么这7个红包的额度在：0.01～（60/7*2）=17.14之间。<br>
  注意：这里的算法是每被抢一个后，剩下的会再次执行上面的这样的算法（Tim老师也觉得上述算法太复杂，不知基于什么样的考虑）。</p>
 <p data-pid="6bpWEI1s">这样算下去，会超过最开始的全部金额，因此到了最后面如果不够这么算，那么会采取如下算法：保证剩余用户能拿到最低1分钱即可。</p>
 <p data-pid="12LVhC1B">如果前面的人手气不好，那么后面的余额越多，红包额度也就越多，因此实际概率一样的。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="RcKzbn5k"><b>4. 红包的设计</b></p>
 <p data-pid="EcDXjH9W">答：微信从财付通拉取金额数据过来，生成个数/红包类型/金额放到redis集群里，app端将红包ID的请求放入请求队列中，如果发现超过红包的个数，直接返回。根据红包的逻辑处理成功得到令牌请求，则由财付通进行一致性调用，通过像比特币一样，两边保存交易记录，交易后交给第三方服务审计，如果交易过程中出现不一致就强制回归。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="OopPRSWn"><b>5. 发性处理：红包如何计算被抢完？</b></p>
 <p data-pid="shTyfZyN">答：cache会抵抗无效请求，将无效的请求过滤掉，实际进入到后台的量不大。cache记录红包个数，原子操作进行个数递减，到0表示被抢光。财付通按照20万笔每秒入账准备，但实际还不到8万每秒。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="E3QaN6jU"><b>6. 通如何保持8w每秒的写入？</b></p>
 <p data-pid="sJ_QeN3P">答：多主sharding，水平扩展机器。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="qGf8q74J"><b>7. 据容量多少？</b></p>
 <p data-pid="ON2zS9as">答：一个红包只占一条记录，有效期只有几天，因此不需要太多空间。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p class="ztext-empty-paragraph"><br></p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="-jXva2gH"><b>8. 询红包分配，压力大不？</b></p>
 <p data-pid="V1tEl0oy">答：抢到红包的人数和红包都在一条cache记录上，没有太大的查询压力。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="0oaUmmJ4"><b>9. 一个红包一个队列？</b></p>
 <p data-pid="CywGlVoW">答：没有队列，一个红包一条数据，数据上有一个计数器字段。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="O_cyaRF1"><b>10.有没有从数据上证明每个红包的概率是不是均等？</b></p>
 <p data-pid="ozWqvv0I">答：不是绝对均等，就是一个简单的拍脑袋算法。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="oItOReGo"><b>11.拍脑袋算法，会不会出现两个最佳？</b></p>
 <p data-pid="yNJDgKk4">答：会出现金额一样的，但是手气最佳只有一个，先抢到的那个最佳。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="FI2keroy"><b>12. 每领一个红包就更新数据么？</b></p>
 <p data-pid="USQSFR--">答：每抢到一个红包，就cas更新剩余金额和红包个数。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="FI_mVcxf"><b>13.红包如何入库入账？</b></p>
 <p data-pid="D1-1qqeD">数据库会累加已经领取的个数与金额，插入一条领取记录。入账则是后台异步操作。</p>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="T_Epu6ni"><b>14. 入帐出错怎么办？比如红包个数没了，但余额还有？</b></p>
 <p data-pid="iP-drux2">答：最后会有一个take all操作。另外还有一个对账来保障。</p>
 <blockquote data-pid="BG6UO3U7">
  原文链接：<a href="https://link.zhihu.com/?target=https%3A//www.zybuluo.com/yulin718/note/93148" class=" wrap external" target="_blank" rel="nofollow noreferrer">微信红包的架构设计简介</a>
 </blockquote>
 <p class="ztext-empty-paragraph"><br></p>
 <p data-pid="pUhN_fmS">---</p>
 <p data-pid="VnWWtMJU">关于金钱，其他回答推荐：</p>
 <p data-pid="BHdblV3R"><a href="https://www.zhihu.com/question/421137387/answer/1485609673" class="internal">生活在消费主义时代的年轻人要怎样存钱？</a></p>
 <p data-pid="oRU427mG"><a href="https://www.zhihu.com/question/421986204/answer/1485421861" class="internal">手里有七十万闲置资金，应该怎么分配投资能有稳定收益而且风险较低，或者可以购买一些什么增值资产？</a></p>
</body>