# 利用爬虫技术能做到哪些很酷很有趣很有用的事情？
- 点赞数：11031
- 更新时间：2016年06月21日07时35分07秒
- 回答url：https://www.zhihu.com/question/27621722/answer/81070075
<body>
 <blockquote data-pid="T0tp4hLr">
  彩蛋：
  <br>
  <br>
  彩蛋已关闭
  <br>
  <br>
  骚瑞
 </blockquote>
 <br>
 <p data-pid="Yn__GuNm">为后来的同学解释一下彩蛋怎么回事，顺便对昨晚12点之后收不到彩蛋的同学抱歉（鞠躬），被屏蔽了</p>
 <ul>
  <li data-pid="IHvDyf-O">彩蛋是如果赞了这条答案会自动收到一条随机的私信，里面是一则短笑话</li>
  <li data-pid="Ag6CnUCH">笑话是在某网站上爬下来的，一共几十条随机发送</li>
 </ul>
 <br>
 <p data-pid="xCsTKBW4">起因是昨天写完原答案，突然想到如果加上彩蛋会不会很多人点赞（说我不是骗赞自己也不信）</p>
 <p data-pid="TEyrMqW7">于是写了个小脚本，跑了起来试了一下</p>
 <p data-pid="SVuUCGjc">第一次高潮出现在回答完30分钟后，突然多了一两百的赞，由于私信发送时间间隔太短，挂掉了</p>
 <p data-pid="Y3dWUGPF">修复后坚持到了晚上十二点，本机和VPS都不能再持续发送私信，于是停掉了</p>
 <p data-pid="gkEUdmzp">今早起来发现赞又多了3000，崩溃的我决定还是不接着发了。。。</p>
 <p data-pid="0DSpYj5F">代码和逻辑如下：</p>
 <div class="highlight">
  <pre><code class="language-text">// 代码不全，只有主要的逻辑
// 用到的库如下：

var request = require('superagent');
var cheerio = require('cheerio');
var fs = require('fs');

// 首先是这样的一个接口，可以取到某个答案所有赞同的人数
// 每次取会返回10条数据，是编译好的HTML模版，还有下一组数据的地址
// 遍历这10条数据并取到所有人的ID即可
// config 是Cookie、Host、Referer等配置

var sourceLink = 'https://www.zhihu.com/answer/' + code + '/voters_profile';

function getVoterList(link, fn) {
var next = '';
if (postListLength &amp;&amp; !sleepIng) {
console.log('waiting');
sleepIng = true;
return setTimeout(function () {
sleepIng = false;
sleep = 1;
getVoterList(link, fn);
}, 1000 * 60);
}
request.get(link)
.set(config)
.end(function (err, res) {
if (err || !res.ok) {
return console.log(err);
}
var result = JSON.parse(res.text), voterList = '', $;

if (result.paging &amp;&amp; result.paging.next) {
next = result.paging.next;
}

if (result.payload &amp;&amp; result.payload.length) {
voterList = result.payload.join('');
$ = cheerio.load(voterList);

$('.zm-rich-follow-btn').each(function () {
var id = $(this).attr('data-id');

if (voterIdList.indexOf(id) === -1 &amp;&amp; oldIdList.indexOf(id) === -1) {
console.log('new id: ', id);
voterIdList.push(id);
} else {
dupIdLen += 1;
}
});
}

if (next &amp;&amp; dupIdLen &lt; 20) {
setTimeout(function () {
getVoterList('https://www.zhihu.com' + next, fn);
}, 3000);
} else {
dupIdLen = 0;
fn();
}
});
}

// 在爬取完该接口后，新的点赞人数会暂存在数组中，遍历该数组，并发送请求
// 如请求发送成功，将各ID保存在某一个文件中，如发送失败，等几分钟后重试

function sendPost() {
var hasError = false;
var tempArr = [];
postListLength = voterIdList.length;
console.log('send post');

if (voterIdList.length) {
voterIdList.forEach(function (id, i) {

if (hasError) {
// 处理发送失败的情况，等待5分钟重试
if (!sleepIng) {
console.log('waiting');
sleepIng = true;
return setTimeout(function () {
sleepIng = false;
sleep = 1;
sendPost();
}, 1000 * 60 * 5);
}

return console.log('has error');
}

var index = (function () {
return i;
})(i);
var postIndex = index &gt; postList.length ? index % postList.length : index;

setTimeout(function () {
// 一波发送完成之前不会启动下一波私信发送
postListLength--;
request.post('https://www.zhihu.com/inbox/post')
.send({
member_id: id,
content: postList[postIndex],
token: '',
_xsrf: '' // 这里是发送者的Cookie
})
.set(config)
.set({"Accept": "*/*"})
.set({"Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"})
.end(function (err, res) {
console.log('hasError: ', hasError);
console.log(new Date());
console.log(res.text);
var resObj = {};

try {
resObj = JSON.parse(res.text);
} catch (e) {
console.log(e);

if (!sleepIng) {
hasError = true;
sleep = 5;
console.log('waiting');
sleepIng = true;
return setTimeout(function () {
sleepIng = false;
sleep = 1;
sendPost();
}, 1000 * 60 * 5);
}
}

if (err || !res.ok || resObj.r !== 0) {
console.log(err);
hasError = true;
sleep = 5;
tempArr = voterIdList.slice(0, index);
oldIdList = oldIdList.concat(tempArr);
fs.writeFile('./idlist.json', oldIdList, function (err) {
if (err) console.log(err);
});
}
});
}, 20 * 1000 * index * sleep);

if (index === voterIdList.length - 1) {
console.log('last');
oldIdList = oldIdList.concat(voterIdList);
voterIdList = [];
setTimeout(function () {
console.log('run again');
getVoterList(sourceLink, sendPost);
}, 1000 * 60 * 15);

fs.writeFile('./idlist.json', oldIdList, function (err) {
if (err) console.log(err);
});

console.log('done ');
}
});
} else {
setTimeout(function () {
console.log('run again');
getVoterList(sourceLink, sendPost);
}, 1000 * 60);
}
}
</code></pre>
 </div>
 <br>
 <p data-pid="rfBizWWe">代码花了半个小时写的，比较糙，不过跑了一下确实能用，既然已经不发了就不改了，有同学要求就发上来了</p>
 <p data-pid="VuY-grbs">PS 知乎的策略应该有变化，昨晚12点之前只要对同一个人两条私信不重复，把握好发送时间间隔就没问题，12点之后我的VPS已经不能用了，时间间隔再久也会返回500错误，1点后我的本机也不行了，不断的返回500和403，Cookie也有更新，索性就停掉了</p>
 <p data-pid="Tr-RzVcH">这是昨晚爬到的ID</p>
 <figure>
  <img src="https://pica.zhimg.com/50/c5b1bfc4f8fc2788d4fd7d5aad081a0e_720w.jpg?source=1940ef5c" data-rawwidth="1270" data-rawheight="906" data-original-token="c5b1bfc4f8fc2788d4fd7d5aad081a0e" class="origin_image zh-lightbox-thumb" width="1270" data-original="https://pic1.zhimg.com/c5b1bfc4f8fc2788d4fd7d5aad081a0e_r.jpg?source=1940ef5c">
 </figure>
 <br>
 <p data-pid="83LU-k-v">还有我的视角所看的我的私信列表＝ ＝</p>
 <figure>
  <img src="https://pic1.zhimg.com/50/e77934b2365659981ca660990d0d9b66_720w.jpg?source=1940ef5c" data-rawwidth="730" data-rawheight="905" data-original-token="e77934b2365659981ca660990d0d9b66" class="origin_image zh-lightbox-thumb" width="730" data-original="https://pica.zhimg.com/e77934b2365659981ca660990d0d9b66_r.jpg?source=1940ef5c">
 </figure>
 <br>
 <p data-pid="lZMSduuq">就酱</p>
 <br>
 <p data-pid="goO0J4xx">＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝</p>
 <p data-pid="7sFfT2zM">某人有一天书荒了，想要看豆瓣上的高分书，然而豆瓣并没有提供按评分的检索，于是拜托我写一个小东西，要求是能按现有标签来分类检索豆瓣图书，并按分数从高到低排序</p>
 <p data-pid="dn8sFDPS">需求不难，就是数据没有，于是写了个爬虫按标签爬下来豆瓣所有的书</p>
 <p data-pid="LQmTocqk">爬的时候只爬了分类的列表，这样有书籍的名称，链接，评分，分类，够用了，而且一次请求可以拿到较多的数据，并发不高的情况下能较快的爬完豆瓣所有的书</p>
 <p data-pid="g6QNdCmV">爬数据的时间大概两个多小时左右，每次请求间隔3秒，倒是没被屏蔽</p>
 <p data-pid="lEDZoXx3">代码用node写的，包括外网访问的服务器，基本满足了某人的需要，现在跑在我自己的VPS上，有域名可以直接访问</p>
 <p data-pid="Zn1MydCs">爬完知道豆瓣热门标签下大概有6万多本书，是会不断更新的，所以还要定期爬一下更新一下数据</p>
 <p data-pid="mh7A_qCl">下面是预览，时间所限页面写的糙了点，反正用户就一个－ －</p>
 <figure>
  <img src="https://pic1.zhimg.com/50/8f321ad177b7f820d98aa71c3c0f9aca_720w.jpg?source=1940ef5c" data-rawwidth="1661" data-rawheight="964" data-original-token="8f321ad177b7f820d98aa71c3c0f9aca" class="origin_image zh-lightbox-thumb" width="1661" data-original="https://pic1.zhimg.com/8f321ad177b7f820d98aa71c3c0f9aca_r.jpg?source=1940ef5c">
 </figure>
 <br>
 <figure>
  <img src="https://pica.zhimg.com/50/9c6b853653c8247f316393a3fccb5053_720w.jpg?source=1940ef5c" data-rawwidth="1663" data-rawheight="964" data-original-token="9c6b853653c8247f316393a3fccb5053" class="origin_image zh-lightbox-thumb" width="1663" data-original="https://pic1.zhimg.com/9c6b853653c8247f316393a3fccb5053_r.jpg?source=1940ef5c">
 </figure>
 <br>
 <figure>
  <img src="https://picx.zhimg.com/50/fcf79abbadc896c6874fe2309a91503d_720w.jpg?source=1940ef5c" data-rawwidth="434" data-rawheight="777" data-original-token="fcf79abbadc896c6874fe2309a91503d" class="origin_image zh-lightbox-thumb" width="434" data-original="https://picx.zhimg.com/fcf79abbadc896c6874fe2309a91503d_r.jpg?source=1940ef5c">
 </figure>
</body>